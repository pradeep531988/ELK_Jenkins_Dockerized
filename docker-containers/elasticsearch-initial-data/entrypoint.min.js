var elasticsearch=require("elasticsearch"),readline=require("readline"),fs=require("fs"),_=require("lodash"),Promise=require("promise"),esHost="192.168.99.100",tweetIndex="tweets",tweetType="example_1_X",tweetFile="data/tweets.jsonl",kibanaFile="data/kibana.jsonl",client=new elasticsearch.Client({host:esHost+":9200",log:"warning"}),esLoad=function(index,type,file){var rd=readline.createInterface({input:fs.createReadStream(file),output:process.stdout,terminal:!1}),loadContent=function(){if(0!=content.length){var n=content.length/2,locContent=_.clone(content);client.bulk({body:locContent},function(error,response){error?console.error("Error when loading bulk for ",index,error):console.log("loading",n,"element from ",file," (",index,"/",type,") elements took",response.took)})}},content=[],i=1;rd.on("line",function(line){var doc=JSON.parse(line),id=doc._id||i;content.push({index:{_index:index||doc._index,_type:type||doc._type,_id:id}}),delete doc._index,delete doc._type,delete doc._id,doc._source&&(doc=doc._source),content.push(doc),(++i-1)%1e3==0&&(loadContent(),content=[])}),rd.on("close",function(){loadContent()})},esLoadTweets=function(){esLoad(tweetIndex,tweetType,tweetFile)},esLoadKibana=function(){esLoad(void 0,void 0,kibanaFile)},esSetDefault=function(){client.search({index:".kibana",type:"config"}).then(function(response){var ids;return _.map(response.hits.hits,"_id")}).then(function(ids){return console.log(".kibana/config ids",ids),Promise.all(_.map(ids,function(id){return client.update({index:".kibana",type:"config",id:id,body:{doc:{defaultIndex:tweetIndex}}})}))}).then(function(response){console.log(response)}).catch(function(error){console.error("error while updating config",error)})},pESReady=new Promise(function(fullfill,reject){var i=0,nMax=60,interv=setInterval(function(){if(60==(i+=1))return console.error("waited for ElasticSearch cluster to come up too long"),clearInterval(interv),void reject("waited ElasticSearch cluster to come up too long");client.search({index:".kibana",type:"config"}).then(function(){clearInterval(interv),fullfill()}).catch(function(){console.log("waiting for ElasticSearch cluster...")})},3e3)});pESReady.then(function(){client.search({index:tweetIndex,type:tweetType},function(error,response){if(error&&404!=error.status)return console.error("Error when searching for ",tweetIndex,"/",tweetType),void console.error(error);response&&response.hits&&0!==response.hits.total?console.log("data are already loaded. exiting"):(console.log("loading initial data"),esLoadTweets(),esLoadKibana(),esSetDefault())})});